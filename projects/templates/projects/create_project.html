{% extends "core/useful/base2.html" %}
{% load i18n %}

{% comment %} {# ---------------------------------------------------------------------
  üìÑ Fichier : create_project.html
  üìÇ Emplacement : projects/templates/projects/create_project.html

  üéØ Page HTML permettant √† un client de publier un projet
  et de d√©finir ses jalons (milestones) directement √† la cr√©ation.

  üß± Formulaire en deux parties :
    1. D√©tails g√©n√©raux du projet
    2. D√©coupage du projet en √©tapes (jalons)
    
  ‚öôÔ∏è JS embarqu√© pour :
    - ajouter des jalons,
    - r√©partir le budget automatiquement,
    - valider que la somme des montants == budget global.
--------------------------------------------------------------------- #} {% endcomment %}

{% block title %}{% trans "Post a New Project" %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 shadow-md rounded-md">
    
    <!-- üß≠ Titre principal -->
    <h2 class="text-2xl font-bold mb-6 text-center">{% trans "Create a New Project" %}</h2>

    <!-- üìå FORMULAIRE PRINCIPAL -->
    <form method="POST" action="">
        {% csrf_token %}

        <!-- ===================== PARTIE 1 : INFOS PROJET ===================== -->

        <div class="mb-10">
            <h3 class="text-xl font-semibold mb-4">{% trans "General Information" %}</h3>

            <!-- üî§ Titre -->
            <label for="title" class="block mb-1 font-medium">{% trans "Project Title" %}</label>
            <input type="text" name="title" id="title" required class="w-full p-3 border rounded mb-4" placeholder="{% trans 'e.g. Bathroom Renovation' %}">

            <!-- üìÑ Description -->
            <label for="description" class="block mb-1 font-medium">{% trans "Description" %}</label>
            <textarea name="description" id="description" rows="5" required class="w-full p-3 border rounded mb-4"></textarea>

            <!-- üõ†Ô∏è Cat√©gorie -->
            <label for="category" class="block mb-1 font-medium">{% trans "Category" %}</label>
            <input type="text" name="category" id="category" required class="w-full p-3 border rounded mb-4">

            <!-- üìç Lieu -->
            <label for="location" class="block mb-1 font-medium">{% trans "Location" %}</label>
            <input type="text" name="location" id="location" required class="w-full p-3 border rounded mb-4">

            <!-- üí∞ Budget total -->
            <label for="budget" class="block mb-1 font-medium">{% trans "Total Budget ($ CAD)" %}</label>
            <input type="number" step="0.01" name="budget" id="budget" required class="w-full p-3 border rounded mb-4">

            <!-- üìÖ Date limite -->
            <label for="deadline" class="block mb-1 font-medium">{% trans "Deadline" %}</label>
            <input type="date" name="deadline" id="deadline" required class="w-full p-3 border rounded mb-4">

            <!-- üåç Visibilit√© -->
            <label for="is_public" class="block mb-1 font-medium">{% trans "Visibility" %}</label>
            <select name="is_public" id="is_public" class="w-full p-3 border rounded mb-4">
                <option value="True">{% trans "Public" %}</option>
                <option value="False">{% trans "Private" %}</option>
            </select>

            <!-- ü§ñ IA ? -->
            <label for="ai_drafted" class="block mb-1 font-medium">{% trans "Drafted with AI?" %}</label>
            <select name="ai_drafted" id="ai_drafted" class="w-full p-3 border rounded mb-4">
                <option value="False">{% trans "No" %}</option>
                <option value="True">{% trans "Yes" %}</option>
            </select>
        </div>

        <!-- ===================== PARTIE 2 : JALONS DU PROJET ===================== -->

        <div>
            <h3 class="text-xl font-semibold mb-4">{% trans "Project Milestones" %}</h3>

            <table class="w-full mb-6 text-sm border border-gray-200" id="milestone-table">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border">{% trans "Title" %}</th>
                        <th class="p-2 border">{% trans "Due Date" %}</th>
                        <th class="p-2 border">{% trans "Amount ($)" %}</th>
                        <th class="p-2 border">{% trans "Remove" %}</th>
                    </tr>
                </thead>
                <tbody id="milestone-body">
                    <!-- üß± 4 jalons initiaux -->
                    {% for i in "1234" %}
                    <tr>
                        <td><input type="text" name="milestone_title[]" class="w-full p-2 border rounded" required></td>
                        <td><input type="date" name="milestone_due[]" class="w-full p-2 border rounded" required></td>
                        <td><input type="number" name="milestone_amount[]" class="w-full p-2 border rounded milestone-amount" step="0.01" required></td>
                        <td class="text-center"><button type="button" onclick="removeRow(this)" class="text-red-500 hover:underline">X</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- ‚ûï Ajouter un jalon -->
            <button type="button" onclick="addMilestone()" class="mb-6 px-4 py-2 bg-gray-100 border rounded hover:bg-gray-200">{% trans "Add Milestone" %}</button>

            <!-- üí° Message d'erreur budget -->
            <p id="budget-warning" class="text-red-600 text-sm hidden">{% trans "The sum of milestone amounts must match the total project budget." %}</p>
        </div>

        <!-- ‚úÖ BOUTON DE SUBMISSION -->
        <button type="submit" class="w-full bg-teal-600 text-white py-3 rounded hover:bg-teal-700">
            {% trans "Publish Project" %}
        </button>
    </form>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
function addMilestone() {
    const tbody = document.getElementById("milestone-body");
    const row = document.createElement("tr");
    row.innerHTML = `
        <td><input type="text" name="milestone_title[]" class="w-full p-2 border rounded" required></td>
        <td><input type="date" name="milestone_due[]" class="w-full p-2 border rounded" required></td>
        <td><input type="number" name="milestone_amount[]" class="w-full p-2 border rounded milestone-amount" step="0.01" required></td>
        <td class="text-center"><button type="button" onclick="removeRow(this)" class="text-red-500 hover:underline">X</button></td>
    `;
    tbody.appendChild(row);
}

function removeRow(button) {
    button.closest("tr").remove();
    validateMilestoneTotal();
}

function validateMilestoneTotal() {
    const budget = parseFloat(document.getElementById("budget").value || 0);
    const amounts = document.querySelectorAll(".milestone-amount");
    let total = 0;
    amounts.forEach(input => total += parseFloat(input.value || 0));

    const warning = document.getElementById("budget-warning");
    if (total.toFixed(2) != budget.toFixed(2)) {
        warning.classList.remove("hidden");
    } else {
        warning.classList.add("hidden");
    }
}

document.getElementById("budget").addEventListener("input", validateMilestoneTotal);
document.addEventListener("input", (e) => {
    if (e.target.classList.contains("milestone-amount")) {
        validateMilestoneTotal();
    }
});
</script>
{% endblock %}
