{% extends "core/base2.html" %}
{% load i18n %}
{# core/templates/core/login.html #}

{% block title %}{% trans "Log in" %}{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-8 shadow-md rounded-md">
    <h2 class="text-2xl font-bold mb-6 text-center">{% trans "Log in to CONTRACT-IT" %}</h2>

    <form id="login-form" method="POST">
        <label for="username" class="block mb-2 font-medium">{% trans "Username" %}</label>
        <input type="text" name="username" id="username" required class="w-full p-3 border rounded mb-4" placeholder="{% trans 'e.g. Ceasar123' %}">

        <label for="password" class="block mb-2 font-medium">{% trans "Password" %}</label>
        <input type="password" name="password" id="password" required class="w-full p-3 border rounded mb-4" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">

        <button type="submit" class="w-full bg-teal-500 text-white py-3 rounded hover:bg-teal-600">
            {% trans "Log in" %}
        </button>
    </form>

    <div id="login-message" class="mt-4 text-center text-green-600 hidden">
        {% trans "Logged in successfully!" %}
    </div>

    <div class="text-center mt-4 text-sm">
        {% trans "Don't have an account?" %}
        <a href="{% url 'signup' %}" class="text-teal-600 hover:underline">{% trans "Sign up" %}</a>
    </div>
</div>

<script>
document.getElementById("login-form").addEventListener("submit", async function(event) {
    event.preventDefault(); // ğŸš« EmpÃªche le rechargement de la page aprÃ¨s soumission du formulaire

    // ğŸ§¾ RÃ©cupÃ¨re les valeurs saisies par lâ€™utilisateur
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    // ğŸ¯ SÃ©lectionne lâ€™Ã©lÃ©ment qui affichera les messages de retour
    const loginMsg = document.getElementById("login-message");

    // ğŸ§¹ RÃ©initialise les styles/messages prÃ©cÃ©dents (cache lâ€™ancien message)
    loginMsg.classList.add("hidden");
    loginMsg.classList.remove("text-red-600", "text-green-600");

    // ğŸ” Envoie des identifiants Ã  lâ€™API backend Django (endpoint JWT)
    const response = await fetch("/api/accounts/login/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"  // âœ… Format JSON requis par lâ€™API
        },
        body: JSON.stringify({ username, password })  // ğŸ” Conversion des donnÃ©es en JSON
    });

    // ğŸ“¦ RÃ©cupÃ©ration de la rÃ©ponse (access, refresh tokens, rÃ´les, erreurs, etc.)
    const data = await response.json();

    if (response.ok) {
        // âœ… Si le login a fonctionnÃ©, on stocke les tokens JWT localement
        localStorage.setItem("access_token", data.access);
        localStorage.setItem("refresh_token", data.refresh);

        // âœ… Affiche un message de succÃ¨s
        loginMsg.classList.remove("hidden");
        loginMsg.classList.add("text-green-600");
        loginMsg.textContent = "{% trans 'Logged in successfully!' %}";

        // ğŸ”„ VÃ©rifie le rÃ´le pour rediriger vers le bon tableau de bord
        const isClient = data.is_client;
        const isContractor = data.is_contractor;

        // ğŸ“ Choix de la redirection selon le rÃ´le
        const redirectUrl = isClient
            ? "/dashboard/client/"           // ğŸ¯ Tableau de bord client (Ã  crÃ©er si non fait)
            : isContractor
            ? "/dashboard/contractor/"       // ğŸ¯ Tableau de bord entrepreneur
            : "/";                           // ğŸ§¯ Fallback si aucun rÃ´le dÃ©tectÃ©

        // ğŸš€ Redirige lâ€™utilisateur vers le bon tableau de bord
        window.location.href = redirectUrl;

    } else {
        // âŒ Si lâ€™authentification Ã©choue, on affiche un message dâ€™erreur
        loginMsg.classList.remove("hidden");
        loginMsg.classList.add("text-red-600");
        loginMsg.textContent = data.detail || "{% trans 'Login failed. Please check your credentials.' %}";
    }
});
</script>


{% endblock %}
