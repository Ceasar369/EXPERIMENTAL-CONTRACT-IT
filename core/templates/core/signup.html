{% extends "core/base2.html" %}
{% load i18n %}
{# core/templates/core/signup.html #}

{% block title %}{% trans "Sign up" %}{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto bg-white p-8 shadow-md rounded-md">
    <h2 class="text-2xl font-bold mb-6 text-center">{% trans "Create an account" %}</h2>

    <form id="signup-form" method="POST">
        <label for="username" class="block mb-2 font-medium">{% trans "Username" %}</label>
        <input type="text" name="username" id="username" required class="w-full p-3 border rounded mb-4">

        <label for="email" class="block mb-2 font-medium">{% trans "Email address" %}</label>
        <input type="email" name="email" id="email" required class="w-full p-3 border rounded mb-4">

        <label for="password" class="block mb-2 font-medium">{% trans "Password" %}</label>
        <input type="password" name="password" id="password" required class="w-full p-3 border rounded mb-4">

        <label for="role" class="block mb-2 font-medium">{% trans "Role:" %}</label>
        <p class="mb-2 font-medium">{% trans "Choose your role(s)" %}</p>

        <label class="inline-flex items-center mb-2 mr-4">
            <input type="checkbox" name="is_client" value="true" class="mr-2">
            {% trans "I am a client" %}
        </label>

        <label class="inline-flex items-center mb-4">
            <input type="checkbox" name="is_contractor" value="true" class="mr-2">
            {% trans "I am a contractor" %}
        </label>


        <label for="phone" class="block mb-2 font-medium">{% trans "Phone number" %}</label>
        <input type="text" name="phone" id="phone" class="w-full p-3 border rounded mb-4">

        <label for="city" class="block mb-2 font-medium">{% trans "City" %}</label>
        <input type="text" name="city" id="city" class="w-full p-3 border rounded mb-4">

        <button type="submit" class="w-full bg-teal-500 text-white py-3 rounded hover:bg-teal-600">
            {% trans "Sign up" %}
        </button>
    </form>

    <div id="signup-message" class="mt-4 text-center text-green-600 hidden">{% trans "Account created successfully!" %}</div>
</div>

<script>
document.getElementById("signup-form").addEventListener("submit", async function(event) {
    event.preventDefault();  // üîí Emp√™che le rechargement de la page

    // üîÅ Donn√©es du formulaire
    const data = {
        username: this.username.value,
        email: this.email.value,
        password: this.password.value,
        is_client: this.is_client.checked,
        is_contractor: this.is_contractor.checked,
        phone: this.phone.value,
        city: this.city.value
    };

    // üîó Appel √† l‚ÄôAPI Django (endpoint RegisterView)
    const response = await fetch("{% url 'register' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
    });

    if (response.status === 201) {
        document.getElementById("signup-message").classList.remove("hidden");

        // üì¶ Connexion automatique : envoie username + password au login endpoint
        const loginResponse = await fetch("{% url 'api-login' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                username: data.username,
                password: data.password
            })
        });

        const loginData = await loginResponse.json();

        if (loginResponse.ok) {
            // ‚úÖ Stockage local des tokens JWT
            localStorage.setItem("access_token", loginData.access);
            localStorage.setItem("refresh_token", loginData.refresh);

            // üîÅ Redirection selon le r√¥le
            const isClient = loginData.is_client;
            const isContractor = loginData.is_contractor;

            const redirectUrl = isClient
                ? "/dashboard/client/"
                : isContractor
                ? "/dashboard/contractor/"
                : "/";

            window.location.href = redirectUrl;
        } else {
            alert("{{ _('Account created, but login failed.') }}");
        }

    } else {
        alert("{{ _('There was a problem. Please try again.') }}");
    }
});
</script>

{% endblock %}
